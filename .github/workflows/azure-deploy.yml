name: Deploy to Azure

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  AZURE_RESOURCE_GROUP: boggle
  DOTNET_VERSION: '8.0.x'
  NODE_VERSION: '20.x'

jobs:
  # ============================================================
  # Detect what changed
  # ============================================================
  changes:
    runs-on: ubuntu-latest
    outputs:
      infra: ${{ steps.filter.outputs.infra }}
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
    steps:
      - uses: actions/checkout@v4
      
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            infra:
              - 'infra/**'
            backend:
              - 'BoggleGame.Server/**'
              - '.github/workflows/**'
            frontend:
              - 'boggle-client/**'
              - '.github/workflows/**'

  # ============================================================
  # Deploy Infrastructure (only if infra/ changed)
  # ============================================================
  deploy-infra:
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.infra == 'true'
    
    steps:
      - uses: actions/checkout@v4

      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Create Resource Group
        run: |
          az group create \
            --name ${{ env.AZURE_RESOURCE_GROUP }} \
            --location eastus \
            --output none || true

      - name: Deploy Bicep
        run: |
          az deployment group create \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --template-file infra/main.bicep \
            --parameters environment=dev \
            --output none

      - name: Get Deployment Outputs
        run: |
          echo "ðŸ“‹ Deployment complete!"
          az deployment group show \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --name main \
            --query "properties.outputs" \
            --output table

  # ============================================================
  # Build and Deploy Backend (.NET)
  # ============================================================
  deploy-backend:
    runs-on: ubuntu-latest
    needs: [changes, deploy-infra]
    # Run if backend changed, OR if infra changed (new app service might need code)
    # Always run if manually triggered
    if: |
      always() &&
      (needs.deploy-infra.result == 'success' || needs.deploy-infra.result == 'skipped') &&
      (needs.changes.outputs.backend == 'true' || needs.changes.outputs.infra == 'true' || github.event_name == 'workflow_dispatch')
    
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore dependencies
        run: dotnet restore BoggleGame.Server/BoggleGame.Server.csproj

      - name: Build
        run: dotnet build BoggleGame.Server/BoggleGame.Server.csproj -c Release --no-restore

      - name: Publish
        run: dotnet publish BoggleGame.Server/BoggleGame.Server.csproj -c Release -o ./publish --no-build

      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get App Service Name
        id: get-app-name
        run: |
          APP_NAME=$(az webapp list --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --query "[?contains(name, 'api')].name" -o tsv | head -1)
          echo "APP_SERVICE_NAME=$APP_NAME" >> $GITHUB_OUTPUT

      - name: Deploy to Azure App Service
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ steps.get-app-name.outputs.APP_SERVICE_NAME }}
          package: ./publish

  # ============================================================
  # Build and Deploy Frontend (Next.js to Static Web Apps)
  # ============================================================
  deploy-frontend:
    runs-on: ubuntu-latest
    needs: [changes, deploy-infra, deploy-backend]
    # Run if frontend changed, OR if infra/backend changed
    if: |
      always() &&
      (needs.deploy-infra.result == 'success' || needs.deploy-infra.result == 'skipped') &&
      (needs.deploy-backend.result == 'success' || needs.deploy-backend.result == 'skipped') &&
      (needs.changes.outputs.frontend == 'true' || needs.changes.outputs.infra == 'true' || github.event_name == 'workflow_dispatch')
    
    steps:
      - uses: actions/checkout@v4

      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get Backend URL
        id: get-backend-url
        run: |
          APP_NAME=$(az webapp list --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --query "[?contains(name, 'api')].name" -o tsv | head -1)
          BACKEND_URL="https://$(az webapp show --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --name $APP_NAME --query 'defaultHostName' -o tsv)"
          echo "BACKEND_URL=$BACKEND_URL" >> $GITHUB_OUTPUT

      - name: Get Static Web App deployment token
        id: get-swa-token
        run: |
          SWA_NAME=$(az staticwebapp list --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --query "[0].name" -o tsv)
          DEPLOYMENT_TOKEN=$(az staticwebapp secrets list --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --name $SWA_NAME --query "properties.apiKey" -o tsv)
          echo "::add-mask::$DEPLOYMENT_TOKEN"
          echo "DEPLOYMENT_TOKEN=$DEPLOYMENT_TOKEN" >> $GITHUB_OUTPUT
          echo "SWA_NAME=$SWA_NAME" >> $GITHUB_OUTPUT

      - name: Build and Deploy to Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ steps.get-swa-token.outputs.DEPLOYMENT_TOKEN }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: "upload"
          app_location: "/boggle-client"
          output_location: ""
          app_build_command: "npm run build"
        env:
          NEXT_PUBLIC_HUB_URL: ${{ steps.get-backend-url.outputs.BACKEND_URL }}/gameHub
